name: ğŸš€ GitOps Pipeline

on:
  workflow_dispatch:
    inputs:
      image:
        description: 'Docker image name (e.g. nginx)'
        required: true
      new_tag:
        description: 'New Docker image tag (e.g. 1.28.1-alpine)'
        required: true
  push:
    paths:
      - 'kubernetes/charts/**/values.yaml'

jobs:
  update-tags:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§± Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Detect updated chart, image, and tag
        id: detect
        run: |
          echo "ğŸ” Detecting updated chart..."
          git_diff=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }})
          values_file=$(echo "$git_diff" | grep 'kubernetes/charts/.*/values.yaml' | head -n1)

          if [ -z "$values_file" ]; then
            echo "âš ï¸ No values.yaml changes detected. Exiting."
            exit 1
          fi

          chart_path=$(dirname "$values_file")
          image=$(yq e '.image.repository' "$values_file")
          tag=$(yq e '.image.tag' "$values_file")

          echo "âœ… Chart path: $chart_path"
          echo "âœ… Image: $image"
          echo "âœ… Tag: $tag"

          echo "chart_path=$chart_path" >> "$GITHUB_OUTPUT"
          echo "image=$image" >> "$GITHUB_OUTPUT"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: ğŸ”§ Update tag in chart's values.yaml
        run: |
          file="${{ steps.detect.outputs.chart_path }}/values.yaml"
          echo "ğŸ”„ Updating image tag in $file..."
          sed -i -E "s|(repository:.*${{ steps.detect.outputs.image }}.*)(\r?\n[[:space:]]*tag: ).*|\1\2${{ steps.detect.outputs.tag }}|" "$file"

      - name: ğŸ§ª Helm lint the updated chart
        run: |
          echo "ğŸ” Linting chart at ${{ steps.detect.outputs.chart_path }}..."
          helm lint "${{ steps.detect.outputs.chart_path }}"

      - name: âœ… Commit and push changes
        run: |
          git config user.name "GitOps Bot ğŸ¤–"
          git config user.email "actions@github.com"
          git add .
          git commit -m "ci(gitops): update ${{ steps.detect.outputs.image }} tag to ${{ steps.detect.outputs.tag }}"
          git push
